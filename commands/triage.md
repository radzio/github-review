---
description: Triage GitHub PR review comments — analyze, plan, and reply
allowed-tools: Bash(gh:*), Bash(bash:*), Read, Grep, Glob
---

# Review PR Comments

You are reviewing GitHub pull request comments for the current branch. Follow these steps exactly.

## Step 1: Fetch PR Reviews

Run the helper script to fetch PR data:

```bash
bash ${CLAUDE_PLUGIN_ROOT}/scripts/fetch-pr-reviews.sh
```

Handle errors by exit code:
- **Exit 1** → "No pull request found for the current branch. Make sure you're on a branch with an open PR."
- **Exit 2** → "Missing required tool. Install `gh` and `jq` via Homebrew: `brew install gh jq`"
- **Exit 3** → "GitHub API error. Check your `gh` authentication with `gh auth status`."

If successful, parse the JSON output and continue.

## Step 2: Summarize PR

Display a summary header:

```
## PR #{number}: {title}
**Branch:** {head_branch} → {base_branch}
**URL:** {url}
**Review status:** {review_decision}
**Comments:** {inline_comments} inline · {review_bodies} review bodies · {general_comments} general
```

If there are zero total discussions, say "No comments found — this PR is clean!" and stop.

## Step 3: Read Context

For each **inline** discussion:
1. Read the referenced file around the specified line (±20 lines of context) using the Read tool
2. Understand what the code does and how the reviewer's comment relates to it

For each **review** body:
1. Check if the comment body references specific files or code patterns
2. If it does, read those files for context
3. Note the review state (CHANGES_REQUESTED, COMMENTED, APPROVED)

For each **general** discussion:
1. Check if the comment body references specific files or code patterns
2. If it does, read those files for context
3. Bot-generated summaries (e.g., containing "AI Code Review Summary", "generated by", or common CI bot patterns) should be noted but don't need file context

## Step 4: List Comments

Present each comment in a structured format, grouped by file:

### For inline comments:

```
### {file}:{line}
**Author:** @{author} · **Status:** {assessment}

> {comment body, abbreviated if very long}

**Assessment:** One of:
- **Actionable** — A valid issue that should be fixed
- **Informational** — Bot summary or FYI, no action needed
- **Already addressed** — The code already handles this concern
- **Needs clarification** — Ambiguous, would need to ask the reviewer
```

### For review bodies:

```
### Review: @{author} ({state})
**Status:** {assessment}

> {review body, abbreviated if very long}
```

### For general comments:

```
### General: @{author}
**Status:** {assessment}

> {comment body, abbreviated if very long}
```

## Step 5: Action Plan

Produce a consolidated action plan with three sections:

### Changes Required
For each actionable comment, provide:
- **File and line** reference
- **What to change** — specific description of the fix
- **Why** — brief explanation connecting it to the reviewer's feedback

### No Action Needed
List comments that are informational, bot-generated, or already addressed, with a one-line reason each.

### Needs Clarification
List comments where the intent is unclear, with a suggested question to ask the reviewer.

For each item, offer: **"Want me to post this question as a reply on the PR?"**

If the user agrees, reply to the specific review comment or conversation:

For inline review comments:
```bash
gh api "repos/{owner}/{repo}/pulls/{number}/comments/{comment_id}/replies" -f body="{message}"
```

For general PR conversation:
```bash
gh pr comment {number} --body "{message}"
```

Where:
- `{owner}/{repo}` — resolved from `gh repo view --json nameWithOwner`
- `{number}` — PR number from Step 1
- `{comment_id}` — the comment `id` from the fetched JSON
- `{message}` — the clarification question

---

**IMPORTANT:** This command is **read-only** for code. Analyze and plan, but do NOT modify any files. You MAY post clarification comments to the PR when the user explicitly approves. Present the action plan and wait for the user to decide what to implement.
