# CLAUDE.md

## Project Overview

`github-review` is a Claude Code plugin that triages GitHub pull request review comments. Given a branch with an open PR, it fetches all review comments (inline, top-level review bodies, and general conversation comments), reads the referenced source files for context, categorizes each comment, produces a consolidated action plan, and optionally posts clarification replies back to the PR.

## Project Structure

```
github-review/
  .claude-plugin/
    plugin.json         # Plugin manifest (name, version, description)
  commands/
    triage.md           # The /triage slash command definition (prompt + tool permissions)
  scripts/
    fetch-pr-reviews.sh # Bash script that fetches PR data via gh CLI and outputs structured JSON
  README.md             # User-facing documentation and install instructions
  CLAUDE.md             # This file
```

### Key Files

- **`.claude-plugin/plugin.json`** -- Minimal plugin manifest. Declares the plugin name (`github-review`), version (`0.1.0`), and description. This is what Claude Code reads to register the plugin.

- **`commands/triage.md`** -- The core of the plugin. This Markdown file defines the `/triage` slash command. It uses YAML frontmatter to declare the command description and allowed tools (`Bash(gh:*)`, `Bash(bash:*)`, `Read`, `Grep`, `Glob`). The body is a multi-step prompt that instructs Claude how to fetch, analyze, categorize, and present PR review comments.

- **`scripts/fetch-pr-reviews.sh`** -- A standalone Bash script that handles all GitHub API interaction. It uses `gh` and `jq` to fetch PR metadata, inline review comments, issue comments, and top-level reviews, then assembles everything into a single JSON object written to stdout.

## How the Plugin Works

### Command: `/triage`

When a user runs `/triage` on a branch with an open PR, Claude follows a five-step process defined in `commands/triage.md`:

1. **Fetch PR Reviews** -- Runs `scripts/fetch-pr-reviews.sh` which calls the GitHub API via `gh` and outputs structured JSON containing PR metadata, inline comments (threaded), general comments (filtered to exclude auto-generated bot comments), and review bodies (excluding dismissed reviews).

2. **Summarize PR** -- Displays a header with PR number, title, branch info, review status, and comment counts. If zero comments exist, it stops early.

3. **Read Context** -- For each discussion, reads the referenced source files (with ~20 lines of surrounding context for inline comments) to understand the code being discussed.

4. **List Comments** -- Presents each comment in a structured format grouped by file. Each comment gets an assessment:
   - **Actionable** -- A valid issue that should be fixed
   - **Informational** -- Bot summary or FYI, no action needed
   - **Already addressed** -- The code already handles the concern
   - **Needs clarification** -- Ambiguous, would need to ask the reviewer

5. **Action Plan** -- Produces three sections:
   - **Changes Required** -- Specific fixes for actionable comments (file, line, what, why)
   - **No Action Needed** -- Informational or already-addressed comments with reasoning
   - **Needs Clarification** -- Ambiguous comments with suggested questions; offers to post replies directly to the PR via `gh api`

### Important Constraint

The `/triage` command is **read-only for code**. It analyzes and plans but does not modify any source files. It may only post clarification comments to the PR when the user explicitly approves.

### Script: `fetch-pr-reviews.sh`

Exit codes:
- `0` -- Success (JSON on stdout)
- `1` -- No PR found for current branch
- `2` -- Missing required tools (`gh` or `jq`)
- `3` -- GitHub API error

The script's JSON output structure:

```json
{
  "pr": {
    "number": 42,
    "title": "...",
    "url": "...",
    "head_branch": "...",
    "base_branch": "...",
    "review_decision": "CHANGES_REQUESTED"
  },
  "summary": {
    "inline_comments": 3,
    "general_comments": 1,
    "review_bodies": 1,
    "total": 5
  },
  "discussions": [
    {
      "type": "inline|review|general",
      "id": "...",
      "file": "path/to/file.ts",
      "line": 42,
      "notes": [
        { "author": "reviewer", "body": "...", "created_at": "...", "updated_at": "..." }
      ]
    }
  ]
}
```

Threading: Inline comments are grouped into threads using `in_reply_to_id`. Each root comment and its replies appear together in the `notes` array.

Filtering: Auto-generated bot comments (matching "generated by" or "auto-generated") are excluded from general comments. Dismissed reviews are excluded from review bodies.

## Development Conventions

- **Plugin manifest** is kept minimal -- just `name`, `version`, `description` in `.claude-plugin/plugin.json`.
- **Commands** are Markdown files in `commands/` with YAML frontmatter specifying `description` and `allowed-tools`.
- **Scripts** live in `scripts/` and are referenced from commands via `${CLAUDE_PLUGIN_ROOT}/scripts/...` to ensure path resolution works regardless of where the plugin is installed.
- **Tool permissions** are scoped narrowly: only `gh` and `bash` for Bash, plus `Read`, `Grep`, `Glob` for file access. No write tools are granted.
- **Error handling** uses structured exit codes (1/2/3) with JSON error messages on stderr.
- The script uses `set -euo pipefail` for strict Bash error handling.
- All GitHub API calls use `--paginate` to handle large PRs.
- The script uses a single `jq -n` invocation at the end to assemble the final JSON, keeping the processing logic in one place.

## Prerequisites

- **gh** (GitHub CLI) -- `brew install gh`, must be authenticated (`gh auth login`)
- **jq** -- `brew install jq`

## Testing / Running Locally

1. Install the plugin into Claude Code:
   ```bash
   claude plugin add .
   ```
   Or for development, symlink it into your Claude Code plugins directory.

2. Navigate to a Git repository with an open PR on the current branch.

3. Run `/triage` in Claude Code.

4. To test the fetch script independently:
   ```bash
   cd /path/to/repo-with-open-pr
   bash scripts/fetch-pr-reviews.sh
   ```
   This outputs the JSON payload that Claude would receive, useful for debugging API issues.

## Notes for Contributors

- The command prompt in `commands/triage.md` is the main logic -- changes to how comments are categorized, presented, or acted upon happen there.
- The fetch script should remain a pure data-fetching layer. All intelligence (categorization, assessment, action planning) lives in the prompt.
- When adding new commands, create a new `.md` file in `commands/` with the same frontmatter pattern.
- The `${CLAUDE_PLUGIN_ROOT}` variable is provided by Claude Code at runtime and resolves to the plugin's installation directory.
- Keep tool permissions minimal. The current command intentionally omits write tools (`Edit`, `Write`) to prevent accidental code modifications during triage.
